<app-header></app-header>

<div class="commandes-en-cours-wrapper">
  <div class="commandes-en-cours-container">
    <div class="page-header">
      <h1 class="page-title">Commandes en cours</h1>
      <div class="header-actions">
        <button class="btn-add-commande" (click)="navigateToNouvelleCommande()" title="Créer une nouvelle commande">
          +
        </button>
        <button class="btn-navigation" (click)="navigateToTerminees()">
          Voir les commandes terminées / annulées
        </button>
      </div>
    </div>

    <div class="loading-area" *ngIf="isLoading()">
      <p>Chargement des commandes...</p>
    </div>

    <div class="table-container" *ngIf="!isLoading()">
      <div class="table-scroll">
        <table class="commandes-table">
          <thead>
            <tr>
              <th *ngFor="let statut of statuts" class="statut-column">
                <div class="statut-header-content">
                  <span class="statut-emoji">{{ statutEmojis[statut] }}</span>
                  <span class="statut-label">{{ getStatutLabel(statut) }}</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td *ngFor="let statut of statuts" class="statut-column">
                <div class="commande-cards">
                  <div 
                    *ngFor="let commande of getCommandesByStatut(statut); trackBy: trackByCommandeId" 
                    class="commande-card"
                    [class.deadline-warning]="getDeadlineStatus(commande) === 'warning'"
                    [class.deadline-danger]="getDeadlineStatus(commande) === 'danger'"
                    [title]="commande.produit || 'Commande #' + commande.id_commande"
                    (click)="onCommandeClick(commande)">
                    <div class="commande-header">
                      <h3 class="commande-title">
                        {{ commande.produit || 'Commande #' + commande.id_commande.substring(0, 8) }}
                      </h3>
                    </div>
                    <div class="commande-info">
                      <p class="commande-client">
                        <strong>Client :</strong>&nbsp;{{ getClientName(commande.client) }}
                      </p>
                      <p class="commande-date">
                        <strong>Date :</strong>&nbsp;{{ formatDate(commande.date_commande) }}
                      </p>
                      <p 
                        class="commande-deadline" 
                        [class.deadline-highlight-warning]="getDeadlineStatus(commande) === 'warning'"
                        [class.deadline-highlight-danger]="getDeadlineStatus(commande) === 'danger'"
                        *ngIf="commande.deadline">
                        <strong>Deadline :</strong>&nbsp;{{ formatDate(commande.deadline) }}
                      </p>
                    </div>
                    <div class="commande-actions">
                      <!-- Afficher les étapes précédentes cochées -->
                      <div class="etapes-precedentes" *ngIf="getEtapesPrecedentes(commande, statut).length > 0" (click)="$event.stopPropagation()">
                        <label 
                          *ngFor="let etapePrecedente of getEtapesPrecedentes(commande, statut)" 
                          class="checkbox-label checkbox-completed">
                          <input 
                            type="checkbox" 
                            [checked]="true"
                            (change)="onEtapePrecedenteChange($event, commande, etapePrecedente)"
                            (click)="$event.stopPropagation()"
                            class="commande-checkbox checkbox-completed-input">
                          <span class="checkbox-text">{{ getStatutLabel(etapePrecedente) }}</span>
                        </label>
                      </div>
                      <!-- Checkbox pour l'étape actuelle -->
                      <label class="checkbox-label" (click)="$event.stopPropagation()">
                        <input 
                          type="checkbox" 
                          [checked]="isCheckboxChecked(commande, statut)"
                          (change)="onCheckboxChange(commande, statut)"
                          (click)="$event.stopPropagation()"
                          class="commande-checkbox">
                        <span class="checkbox-text">Terminé</span>
                      </label>
                    </div>
                  </div>
                  <div *ngIf="getCommandesByStatut(statut).length === 0" class="empty-column">
                    <p class="empty-message">Aucune commande</p>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
