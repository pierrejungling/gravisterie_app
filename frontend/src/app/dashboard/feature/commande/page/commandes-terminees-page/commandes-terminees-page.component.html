<app-header></app-header>

<div class="commandes-terminees-wrapper">
  <div class="commandes-terminees-container">
    <div class="page-header">
      <h1 class="page-title">Commandes et ventes<br>terminées / annulées</h1>
      <div class="page-header__actions">
        <div class="group-mode group-mode--desktop">
          <button
            type="button"
            class="group-mode__btn"
            [class.active]="groupMode() === 'month'"
            (click)="setGroupMode('month')">
            Par mois
          </button>
          <button
            type="button"
            class="group-mode__btn"
            [class.active]="groupMode() === 'year'"
            (click)="setGroupMode('year')">
            Par année
          </button>
        </div>
        <button class="btn-navigation" (click)="navigateToEnCours()">
          Voir les commandes en cours
        </button>
      </div>
    </div>

    <div class="loading-area" *ngIf="isLoading()">
      <p>Chargement des commandes...</p>
    </div>

    <div class="commandes-list" *ngIf="!isLoading()">
      <div class="group-mode group-mode--mobile-top">
        <button
          type="button"
          class="group-mode__btn"
          [class.active]="groupMode() === 'month'"
          (click)="setGroupMode('month')">
          Par mois
        </button>
        <button
          type="button"
          class="group-mode__btn"
          [class.active]="groupMode() === 'year'"
          (click)="setGroupMode('year')">
          Par année
        </button>
      </div>
      <!-- Bloc Commandes terminées -->
      <div class="commandes-section">
        <h2 class="section-title">Commandes et ventes terminées</h2>
        <div 
          *ngIf="commandesTerminees().length === 0" 
          class="empty-state">
          <p class="empty-message">Aucune commande terminée</p>
        </div>

        <div class="commandes-group" *ngFor="let group of groupedCommandesTerminees()">
          <h3 class="group-title">{{ group.label }} | {{ group.total | number:'1.0-2' }} €</h3>
          <div class="commandes-grid">
            <div 
              *ngFor="let commande of group.commandes; trackBy: trackByCommandeId" 
              class="commande-card"
              [title]="commande.produit || 'Commande #' + commande.id_commande"
              (click)="onCommandeClick(commande)">
              <span
                class="payment-indicator payment-indicator--unpaid"
                *ngIf="!commande['payé'] && commande.prix_final && commande.prix_final > 0">
                Non payé
              </span>
              <div class="commande-header">
                <h3 class="commande-title">
                  {{ commande.produit || 'Commande #' + commande.id_commande.substring(0, 8) }}
                </h3>
                <span class="commande-status-badge">
                  Terminée
                </span>
              </div>
              <div class="commande-info">
                <p class="commande-client">
                  <strong>Client :</strong>&nbsp;{{ getClientName(commande.client) }}
                </p>
                <p class="commande-societe" *ngIf="commande.client['société']">
                  <strong>Société :</strong>&nbsp;{{ commande.client['société'] }}
                </p>
                <p class="commande-date">
                  <strong>{{ isVente(commande) ? 'Date de la vente' : 'Date de commande' }} :</strong>&nbsp;{{ formatDate(commande.date_commande) }}
                </p>
                <p class="commande-deadline" *ngIf="commande.deadline">
                  <strong>Deadline :</strong>&nbsp;{{ formatDate(commande.deadline) }}
                </p>
                <p class="commande-prix" *ngIf="commande.prix_final">
                  <strong>Prix final :</strong>&nbsp;{{ commande.prix_final }} €
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bloc Commandes annulées -->
      <div class="commandes-section">
        <h2 class="section-title">Commandes et ventes annulées</h2>
        <div 
          *ngIf="commandesAnnulees().length === 0" 
          class="empty-state">
          <p class="empty-message">Aucune commande annulée</p>
        </div>

        <div class="commandes-group" *ngFor="let group of groupedCommandesAnnulees()">
          <h3 class="group-title">{{ group.label }} | {{ group.total | number:'1.0-2' }} €</h3>
          <div class="commandes-grid">
            <div 
              *ngFor="let commande of group.commandes; trackBy: trackByCommandeId" 
              class="commande-card commande-annulee"
              [title]="commande.produit || 'Commande #' + commande.id_commande"
              (click)="onCommandeClick(commande)">
              <span
                class="payment-indicator payment-indicator--unpaid"
                *ngIf="!commande['payé'] && commande.prix_final && commande.prix_final > 0">
                Non payé
              </span>
              <div class="commande-header">
                <h3 class="commande-title">
                  {{ commande.produit || 'Commande #' + commande.id_commande.substring(0, 8) }}
                </h3>
                <span class="commande-status-badge badge-annulee">
                  Annulée
                </span>
              </div>
              <div class="commande-info">
                <p class="commande-client">
                  <strong>Client :</strong>&nbsp;{{ getClientName(commande.client) }}
                </p>
                <p class="commande-societe" *ngIf="commande.client['société']">
                  <strong>Société :</strong>&nbsp;{{ commande.client['société'] }}
                </p>
                <p class="commande-date">
                  <strong>{{ isVente(commande) ? 'Date de la vente' : 'Date de commande' }} :</strong>&nbsp;{{ formatDate(commande.date_commande) }}
                </p>
                <p class="commande-deadline" *ngIf="commande.deadline">
                  <strong>Deadline :</strong>&nbsp;{{ formatDate(commande.deadline) }}
                </p>
                <p class="commande-prix" *ngIf="commande.prix_final">
                  <strong>Prix final :</strong>&nbsp;{{ commande.prix_final }} €
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
