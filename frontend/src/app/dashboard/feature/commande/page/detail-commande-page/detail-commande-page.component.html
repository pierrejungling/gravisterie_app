<app-header></app-header>

<!-- Barre d'actions fixe (desktop) -->
<div class="detail-actions-bar" *ngIf="!isLoading() && commande() && formGroup">
  <div class="detail-actions-bar__container">
    <div class="detail-actions-bar__left">
      <button 
        type="button" 
        class="btn-action-bar btn-toggle-prix"
        (click)="togglePrixFields()"
        [title]="showPrixFields() ? 'Masquer les frais' : 'Afficher les frais'">
        {{ showPrixFields() ? 'üí∞ Masquer frais' : 'üí∞ Afficher frais' }}
      </button>
      <button 
        type="button" 
        class="btn-action-bar btn-edit"
        (click)="toggleEditMode()"
        [title]="isEditMode() ? 'Annuler' : 'Modifier'">
        {{ isEditMode() ? '‚úï Annuler' : '‚úèÔ∏è Modifier' }}
      </button>
      <button 
        type="button" 
        class="btn-action-bar btn-delete"
        (click)="openDeleteConfirm()"
        title="Supprimer la commande">
        üóëÔ∏è Supprimer
      </button>
    </div>
    <div class="detail-actions-bar__right">
      <div class="attente-reponse-toggle-bar" *ngIf="!isVente()">
        <label class="toggle-switch-small" [class.toggle-vert]="get('attente_reponse').value" [class.toggle-rouge]="!get('attente_reponse').value">
          <input 
            type="checkbox" 
            [formControl]="get('attente_reponse')"
            (change)="onAttenteReponseChange()"
            class="toggle-input">
          <span class="toggle-slider"></span>
          <span class="toggle-label-small">{{ get('attente_reponse').value ? 'Rien √† faire' : 'Client attend' }}</span>
        </label>
      </div>
      <ng-container *ngIf="isEditMode()">
        <button type="submit" form="detailCommandeForm" class="btn-action-bar btn-save" [disabled]="!formGroup.valid">üíæ Enregistrer</button>
      </ng-container>
    </div>
  </div>
</div>

<div class="detail-commande-wrapper">
  <div 
    class="detail-commande-container" 
    [class.deadline-warning]="getDeadlineStatus() === 'warning' && !isCommandeTerminee() && !isCommandeAnnulee()"
    [class.deadline-danger]="getDeadlineStatus() === 'danger' && !isCommandeTerminee() && !isCommandeAnnulee()"
    *ngIf="!isLoading() && commande()">
    <div class="detail-header">
      <div class="header-title-section">
        <h1 class="page-title">D√©tail de la {{ isVente() ? 'vente' : 'commande' }}</h1>
        <div class="commande-title-row" *ngIf="!isEditMode()">
          <h2 class="commande-title-main">
            {{ commande()?.produit || 'Commande #' + (commande()?.id_commande?.substring(0, 8) || '') }}
          </h2>
          <div class="detail-status-badge detail-status-badge--terminee" *ngIf="isCommandeTerminee()">Termin√©e</div>
          <div class="detail-status-badge detail-status-badge--annulee" *ngIf="isCommandeAnnulee()">Annul√©e</div>
        </div>
        <div class="commande-title-edit" *ngIf="isEditMode()">
          <app-floating-label-input
            [label]="isVente() ? 'Nom / Intitul√© de la vente' : 'Nom / Intitul√© de la commande'"
            [control]="get('nom_commande')"
            [formGroup]="formGroup"
            [readonly]="false">
          </app-floating-label-input>
        </div>
      </div>
      <!-- Les boutons sont maintenant dans la barre fixe en haut -->
    </div>

    <section class="detail-duplicate-section" *ngIf="isCommandeTerminee()">
      <button
        type="button"
        class="btn-duplicate"
        (click)="duplicateCommande()"
        [disabled]="isDuplicating()">
        {{ isDuplicating() ? 'Duplication en cours...' : 'Dupliquer la ' + (isVente() ? 'vente' : 'commande') }}
      </button>
    </section>

    <form id="detailCommandeForm" [formGroup]="formGroup" *ngIf="formGroup" (ngSubmit)="onSave()">
      
      <!-- Informations de la commande -->
      <section class="form-section">
        <h2 class="section-title">Informations de la {{ isVente() ? 'vente' : 'commande' }}</h2>
        <p class="commande-date-display" *ngIf="!isEditMode()">
          <strong>{{ isVente() ? 'Date de la vente' : 'Date de commande' }} :</strong>&nbsp;{{ formatDate(commande()?.date_commande || '') }}
        </p>
        <div class="input-wrapper" *ngIf="isEditMode()">
          <app-floating-label-input
            [label]="isVente() ? 'Date de la vente' : 'Date de commande'"
            [control]="get('date_commande')"
            [formGroup]="formGroup"
            type="date"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>
        <div 
          class="input-wrapper"
          [class.deadline-highlight-warning]="getDeadlineStatus() === 'warning' && !isCommandeTerminee() && !isCommandeAnnulee()"
          [class.deadline-highlight-danger]="getDeadlineStatus() === 'danger' && !isCommandeTerminee() && !isCommandeAnnulee()"
          *ngIf="!isVente()">
          <app-floating-label-input
            [label]="'Deadline'"
            [control]="get('deadline')"
            [formGroup]="formGroup"
            type="date"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <div class="textarea-container">
            <textarea
              class="description-textarea"
              formControlName="description"
              [readonly]="!isEditMode()"
              [disabled]="!isEditMode()"
              rows="4"
              placeholder=" "></textarea>
            <label class="textarea-label" [class.fixed-label]="get('description').value && get('description').value.length > 0">
              {{ isVente() ? 'Description' : 'Description du projet' }}
            </label>
          </div>
        </div>

        <div class="input-wrapper" *ngIf="!isVente()">
          <app-floating-label-input
            [label]="'Dimensions souhait√©es'"
            [control]="get('dimensions')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper" *ngIf="!isVente()">
          <app-floating-label-input
            [label]="'Support'"
            [control]="get('support')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <!-- Fichiers joints -->
        <section class="form-section fichiers-section">
          <h2 class="section-title">Fichiers joints</h2>
          <p class="fichiers-hint" *ngIf="commandeFichiersSorted().length === 0">Aucun fichier pour cette {{ isVente() ? 'vente' : 'commande' }}.</p>
          <ul class="fichiers-list" *ngIf="commandeFichiersSorted().length > 0">
            <li *ngFor="let fichier of commandeFichiersSorted()" class="fichiers-list-item">
              <button
                *ngIf="isPreviewableImageFichier(fichier) && fichierPreviewUrls()[fichier.id_fichier]"
                type="button"
                class="fichiers-list-thumb-btn"
                (click)="openPreview(fichier)"
                title="Voir en grand">
                <img
                  [src]="fichierPreviewUrls()[fichier.id_fichier]"
                  [alt]="fichier.nom_fichier"
                  class="fichiers-list-thumb">
              </button>
              <button
                *ngIf="isPdfFichier(fichier)"
                type="button"
                class="fichiers-list-thumb-btn fichiers-list-pdf-btn"
                (click)="openPreviewPdf(fichier)"
                title="Pr√©visualiser le PDF">
                <span class="fichiers-list-pdf-icon">üìÑ</span>
              </button>
              <button
                *ngIf="isDocxFichier(fichier)"
                type="button"
                class="fichiers-list-thumb-btn fichiers-list-docx-btn"
                (click)="openPreviewDocx(fichier)"
                title="Pr√©visualiser le document Word">
                <span class="fichiers-list-docx-icon">üìù</span>
              </button>
              <span class="fichiers-list-icon" *ngIf="!isPreviewableImageFichier(fichier) && !isPdfFichier(fichier) && !isDocxFichier(fichier)">üìÑ</span>
              <span class="fichiers-list-placeholder" *ngIf="isPreviewableImageFichier(fichier) && !fichierPreviewUrls()[fichier.id_fichier]">üñº</span>
              <span class="fichiers-list-name" [title]="fichier.nom_fichier">{{ fichier.nom_fichier }}</span>
              <span class="fichiers-list-size" *ngIf="fichier.taille_octets">{{ (fichier.taille_octets / 1024) | number:'1.0-0' }} Ko</span>
              <div class="fichiers-list-actions">
                <button type="button" class="btn-fichier btn-download btn-icon" (click)="downloadFichier(fichier)" title="T√©l√©charger">‚¨á</button>
                <button type="button" class="btn-fichier btn-delete btn-icon" (click)="deleteFichier(fichier.id_fichier)" title="Supprimer">üóë</button>
              </div>
            </li>
          </ul>
          <div class="input-wrapper fichiers-add-wrapper">
            <label class="label">Ajouter un fichier</label>
            <p class="fichiers-add-hint">Images, SVG, PDF, DOC/DOCX. Plusieurs fichiers possibles.</p>
            <div
              class="fichiers-drop-zone"
              [class.drag-over]="isDragOver()"
              [class.uploading]="fichierUploading()"
              (click)="fileInputRef.click()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)">
              <input
                #fileInputRef
                type="file"
                class="fichiers-input-hidden"
                multiple
                accept="image/*,.pdf,.doc,.docx,.svg"
                [disabled]="fichierUploading()"
                (change)="onFichierSelected($event)"
                (click)="$event.stopPropagation()">
              <span class="fichiers-drop-text" *ngIf="!fichierUploading()">Glissez des images ou des fichiers ici, ou cliquez pour parcourir</span>
              <span class="fichiers-drop-text fichiers-add-loading" *ngIf="fichierUploading()">Envoi en cours‚Ä¶</span>
            </div>
          </div>
        </section>
      </section>

      <!-- Modal pr√©visualisation image, PDF ou DOCX -->
      <div
        class="preview-overlay"
        *ngIf="previewImageUrl() || previewPdfUrl() || previewDocxBlob()"
        (click)="closePreview()"
        role="button"
        tabindex="0"
        aria-label="Fermer l'aper√ßu">
        <button type="button" class="preview-close" (click)="closePreview(); $event.stopPropagation()" title="Fermer">‚úï</button>
        <div class="preview-content" [class.preview-content--pdf]="previewPdfUrl()" [class.preview-content--docx]="previewDocxBlob()" (click)="$event.stopPropagation()">
          <img *ngIf="previewImageUrl()" [src]="previewImageUrl() | safeUrl" alt="Aper√ßu" class="preview-image">
          <iframe *ngIf="previewPdfUrl()" [src]="previewPdfUrl() | safeResourceUrl" class="preview-pdf" title="Aper√ßu PDF"></iframe>
          <div *ngIf="previewDocxBlob()" id="docx-preview-container" class="preview-docx"></div>
        </div>
      </div>

      <!-- Prix et Frais -->
      <section class="form-section">
        <h2 class="section-title">Prix et Frais</h2>

        <!-- Quantit√© et Prix -->
        <div class="prix-quantity-group" *ngIf="!isVente()">
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Quantit√©'"
              [control]="get('quantit√©')"
              [formGroup]="formGroup"
              type="number"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>

          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Prix unitaire final'"
              [control]="get('prix_unitaire_final')"
              [formGroup]="formGroup"
              type="number"
              step="0.01"
              suffix="‚Ç¨"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>

          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Prix final'"
              [control]="get('prix_final')"
              [formGroup]="formGroup"
              type="number"
              step="0.01"
              suffix="‚Ç¨"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>
        </div>

        <div class="prix-quantity-group" *ngIf="isVente()">
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Prix final'"
              [control]="get('prix_final')"
              [formGroup]="formGroup"
              type="number"
              step="0.01"
              suffix="‚Ç¨"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>
        </div>

        <div class="input-wrapper">
          <div class="paye-status-block" [class.paye-oui]="get('pay√©').value" [class.paye-non]="!get('pay√©').value">
            <label class="checkbox-label-paye">
              <input
                type="checkbox"
                formControlName="pay√©"
                (change)="onPayeChange()">
              <span class="paye-label-text">{{ get('pay√©').value ? 'Pay√©' : 'Non pay√©' }}</span>
            </label>
            <div class="paye-commentaire-wrapper">
              <textarea
                class="paye-commentaire-input"
                formControlName="commentaire_paye"
                placeholder="Commentaire..."
                rows="3"
                [readonly]="!isEditMode()"
                [disabled]="!isEditMode()">
              </textarea>
            </div>
          </div>
        </div>

        <!-- Champs de prix du support (masqu√©s par d√©faut) -->
        <div class="prix-fields" *ngIf="showPrixFields()">
          <h3 class="supports-title">Support / Frais</h3>
          
          <!-- Liste des supports -->
          <div formArrayName="supports" class="supports-list">
            <div *ngFor="let supportControl of supportsFormArray.controls; let i = index" 
                 [formGroupName]="i" 
                 class="support-item">
              <ng-container [formGroup]="$any(supportControl)">
                <!-- Nom du support -->
                <div class="input-wrapper">
                  <app-floating-label-input
                    [label]="'Nom du support / frais'"
                    [control]="$any(supportControl).get('nom_support')!"
                    [formGroup]="$any(supportControl)"
                    [readonly]="!isEditMode()">
                  </app-floating-label-input>
                </div>

                <!-- Toggle Prix support unitaire (au-dessus du champ prix support) -->
                <div class="support-toggle-row">
                  <label class="toggle-switch-small" [class.toggle-vert]="isPrixUnitaire($any(supportControl))" [class.toggle-rouge]="!isPrixUnitaire($any(supportControl))">
                    <input
                      type="checkbox"
                      formControlName="prix_unitaire"
                      [disabled]="!isEditMode()"
                      class="toggle-input">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label-small">{{ isPrixUnitaire($any(supportControl)) ? 'Prix unitaire' : 'Prix pour X unit√©s' }}</span>
                  </label>
                </div>

                <!-- Prix support et URL support sur la m√™me ligne -->
                <div class="support-price-url-row">
                  <div class="input-wrapper">
                    <app-floating-label-input
                      [label]="isPrixUnitaire($any(supportControl)) ? 'Prix unitaire' : 'Prix total'"
                      [control]="$any(supportControl).get('prix_support')!"
                      [formGroup]="$any(supportControl)"
                      type="number"
                      step="0.01"
                      suffix="‚Ç¨"
                      [readonly]="!isEditMode()">
                    </app-floating-label-input>
                  </div>

                  <div class="input-wrapper">
                    <app-floating-label-input
                      [label]="'URL'"
                      [control]="$any(supportControl).get('url_support')!"
                      [formGroup]="$any(supportControl)"
                      [readonly]="!isEditMode()">
                    </app-floating-label-input>
                  </div>
                </div>

                <!-- Texte "Le prix ci-dessus correspond √† X unit√©(s)" (en dessous du champ prix support total) -->
                <div class="support-prix-pour-unites" *ngIf="!isPrixUnitaire($any(supportControl))">
                  <span>Le prix ci-dessus correspond √†</span>
                  <input
                    type="number"
                    formControlName="nombre_unites"
                    class="nombre-unites-input"
                    [disabled]="!isEditMode() || isPrixUnitaire($any(supportControl))"
                    placeholder="X"
                    min="1">
                  <span>unit√©(s)</span>
                </div>

                <!-- Prix support unitaire calcul√© (read-only) -->
                <div class="input-wrapper">
                  <app-floating-label-input
                    [label]="'Prix unitaire (calcul√©)'"
                    [control]="$any(supportControl).get('prix_support_unitaire')!"
                    [formGroup]="$any(supportControl)"
                    type="number"
                    step="0.01"
                    suffix="‚Ç¨"
                    [readonly]="true">
                  </app-floating-label-input>
                </div>
              </ng-container>

              <!-- Bouton supprimer -->
              <button
                type="button"
                class="btn-remove-support"
                (click)="removeSupport(i)"
                [disabled]="!isEditMode() || supportsFormArray.length <= 1"
                *ngIf="isEditMode() && supportsFormArray.length > 1">
                Supprimer
              </button>
            </div>
          </div>

          <!-- Bouton ajouter support -->
          <button
            type="button"
            class="btn-add-support"
            (click)="addSupport()"
            [disabled]="!isEditMode()"
            *ngIf="isEditMode()">
            + Ajouter un nouveau support / frais
          </button>

          <!-- R√©capitulatifs d√©taill√©s -->
          <div class="prix-recapitulatif">
            <h4 class="recap-title">D√©tails des frais</h4>
            <table class="recap-table">
              <thead>
                <tr>
                  <th>Support / Frais</th>
                  <th>Prix unitaire</th>
                  <th>Quantit√©</th>
                  <th>Prix total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let supportControl of supportsFormArray.controls; let i = index">
                  <td class="support-name-cell">
                    {{ $any(supportControl).get('nom_support')?.value || 'Support ' + (i + 1) }}
                  </td>
                  <td class="price-cell">
                    {{ ($any(supportControl).get('prix_support_unitaire')?.value || 0) | number:'1.2-2' }} ‚Ç¨
                  </td>
                  <td class="quantity-cell">
                    {{ get('quantit√©').value || 1 }}
                  </td>
                  <td class="total-cell">
                    {{ (($any(supportControl).get('prix_support_unitaire')?.value || 0) * (get('quantit√©').value || 1)) | number:'1.2-2' }} ‚Ç¨
                  </td>
                </tr>
                <tr *ngIf="supportsFormArray.length === 0" class="empty-row">
                  <td colspan="4" class="empty-message">Aucun support</td>
                </tr>
                <tr class="total-row">
                  <td class="total-label"><strong>Total</strong></td>
                  <td class="total-cell"><strong>{{ get('prix_final_supports_unitaires').value || '0.00' }} ‚Ç¨</strong></td>
                  <td class="quantity-cell"><strong>{{ get('quantit√©').value || 1 }}</strong></td>
                  <td class="total-cell"><strong>{{ get('prix_final_supports').value || '0.00' }} ‚Ç¨</strong></td>
                </tr>
              </tbody>
            </table>
            <div class="recap-summary">
              <div class="recap-summary-item">
                <span class="recap-label"><strong>Prix final de vente :</strong></span>
                <span class="recap-value"><strong>{{ get('prix_final').value || '0.00' }} ‚Ç¨</strong></span>
              </div>
              <div class="recap-summary-item benefit-item">
                <span class="recap-label"><strong>Prix b√©n√©fice :</strong></span>
                <span class="recap-value benefit-value"><strong>{{ get('prix_benefice').value || '0.00' }} ‚Ç¨</strong></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Coordonn√©es de contact -->
      <section class="form-section">
        <h2 class="section-title">Coordonn√©es de contact</h2>
        
        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Nom'"
            [control]="get('nom')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Pr√©nom'"
            [control]="get('prenom')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'T√©l√©phone'"
            [control]="get('telephone')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Email'"
            [control]="get('mail')!"
            [formGroup]="formGroup"
            type="email"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <!-- Adresse d√©compos√©e -->
        <div class="address-section">
          <label class="section-subtitle">Adresse</label>
          
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Rue et num√©ro'"
              [control]="get('rue')!"
              [formGroup]="formGroup"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>

          <div class="form-row">
            <div class="input-wrapper">
              <app-floating-label-input
                [label]="'Code postal'"
                [control]="get('code_postal')!"
                [formGroup]="formGroup"
                [readonly]="!isEditMode()">
              </app-floating-label-input>
            </div>
            
            <div class="input-wrapper">
              <app-floating-label-input
                [label]="'Ville'"
                [control]="get('ville')!"
                [formGroup]="formGroup"
                [readonly]="!isEditMode()">
              </app-floating-label-input>
            </div>
          </div>

          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Pays'"
              [control]="get('pays')!"
              [formGroup]="formGroup"
              [readonly]="!isEditMode()">
            </app-floating-label-input>
          </div>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'D√©nomination sociale'"
            [control]="get('societe')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'N¬∞ de TVA'"
            [control]="get('tva')!"
            [formGroup]="formGroup"
            [readonly]="!isEditMode()">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <label class="label">Mode de contact pr√©f√©r√©</label>
          <div class="mode-contact-radio-group" [class.disabled]="!isEditMode()">
            <label *ngFor="let mode of modesContact" class="mode-contact-radio-label" [class.disabled]="!isEditMode()">
              <input
                type="radio"
                name="mode_contact"
                [value]="mode.value"
                [formControl]="get('mode_contact')">
              <span class="mode-contact-emoji">{{ mode.emoji }}</span>
              <span>{{ mode.label }}</span>
            </label>
          </div>
        </div>
      </section>
    </form>

    <!-- Personnalisation -->
    <section class="form-section form-section--spaced" *ngIf="!isVente()">
      <h2 class="section-title">Personnalisation</h2>

      <!-- Couleur (s√©lection multiple) -->
      <div class="input-wrapper">
        <label class="label">Couleur (s√©lection multiple)</label>
        <div class="couleurs-grid" [class.disabled]="!isEditMode()">
          <label 
            *ngFor="let couleur of couleursDisponibles" 
            class="couleur-checkbox-label"
            [class.selected]="isCouleurSelected(couleur)"
            [class.disabled]="!isEditMode()">
            <input 
              type="checkbox" 
              [checked]="isCouleurSelected(couleur)"
              [disabled]="!isEditMode()"
              (change)="toggleCouleur(couleur)"
              class="couleur-checkbox">
            <span class="couleur-label">{{ couleur }}</span>
          </label>
        </div>
      </div>

      <!-- Police d'√©criture -->
      <div class="input-wrapper">
        <app-floating-label-input
          [label]="'Police d\'√©criture'"
          [control]="get('police_ecriture')!"
          [formGroup]="formGroup"
          [readonly]="!isEditMode()">
        </app-floating-label-input>
      </div>

      <!-- Texte de la personnalisation -->
      <div class="input-wrapper">
        <app-floating-label-input
          [label]="'Texte de la personnalisation'"
          [control]="get('texte_personnalisation')"
          [formGroup]="formGroup"
          [readonly]="!isEditMode()">
        </app-floating-label-input>
      </div>
    </section>

    <!-- PCs r√©alis√©s -->
    <section class="form-section pcs-realises-section" *ngIf="!isVente()">
      <h2 class="section-title">Quantit√© produite</h2>
      <div class="pcs-realises-wrapper" [class.pcs-realises-disabled]="!isQuantiteRealiseeEditable()">
        <div class="pcs-realises-block">
          <div class="pcs-realises-input-row">
            <input
              type="number"
              class="pcs-realises-input"
              [formControl]="get('quantite_realisee')"
              (change)="onQuantiteRealiseeChange()"
              [min]="0"
              [max]="get('quantit√©').value || 1"
              placeholder="0">
            <span class="pcs-realises-separator">/</span>
            <span class="pcs-realises-total">{{ get('quantit√©').value || 1 }}</span>
            <div class="pcs-realises-buttons" *ngIf="isQuantiteRealiseeEditable()">
              <button type="button" class="pcs-btn pcs-btn-minus" (click)="decrementQuantiteRealisee()" title="Diminuer">‚àí</button>
              <button type="button" class="pcs-btn pcs-btn-plus" (click)="incrementQuantiteRealisee()" title="Augmenter">+</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Statuts de la commande -->
    <section class="statuts-section" *ngIf="!isVente()">
      <div class="statuts-section__title-row">
        <h2 class="section-title">Statuts de la commande</h2>
        <div class="detail-status-badge detail-status-badge--terminee" *ngIf="isCommandeTerminee()">Termin√©e</div>
        <div class="detail-status-badge detail-status-badge--annulee" *ngIf="isCommandeAnnulee()">Annul√©e</div>
      </div>
      
      <div class="statuts-list">
        <label 
          *ngFor="let statut of allStatuts" 
          class="statut-checkbox-label"
          [class.active]="(isStatutActuel(statut) || isStatutActif(statut)) && !isStatutChecked(statut)"
          [class.completed]="isStatutChecked(statut)"
          [class.cancelled]="statut === StatutCommande.ANNULEE && isStatutChecked(statut)"
          [class.disabled]="isStatutDisabled(statut) && !isStatutChecked(statut)">
          <input 
            type="checkbox" 
            [checked]="isStatutChecked(statut)"
            [disabled]="isStatutDisabled(statut) && !isStatutChecked(statut)"
            (change)="onStatutChange(statut, $event)"
            class="statut-checkbox">
          <span class="statut-label">{{ statutLabels[statut] }}</span>
        </label>
      </div>
    </section>

  </div>

  <!-- Footer fixe mobile/tablette : Afficher prix, Supprimer, Modifier / Annuler+Enregistrer, + Toggle attente r√©ponse -->
  <footer class="detail-actions-footer" *ngIf="!isLoading() && commande() && formGroup">
    <div class="detail-actions-footer__buttons">
      <div class="detail-actions-footer__row">
        <button type="button" class="btn-footer btn-footer-prix" (click)="togglePrixFields()">
          {{ showPrixFields() ? 'üí∞ Masquer frais' : 'üí∞ Afficher frais' }}
        </button>
        <button type="button" class="btn-footer btn-footer-delete" (click)="openDeleteConfirm()">üóëÔ∏è Supprimer</button>
      </div>
      <div class="detail-actions-footer__row">
        <ng-container *ngIf="!isEditMode()">
          <button type="button" class="btn-footer btn-footer-edit" (click)="toggleEditMode()">‚úèÔ∏è Modifier</button>
        </ng-container>
        <ng-container *ngIf="isEditMode()">
          <button type="button" class="btn-footer btn-footer-cancel" (click)="onCancel()">Annuler</button>
          <button type="submit" form="detailCommandeForm" class="btn-footer btn-footer-save" [disabled]="!formGroup.valid">Enregistrer</button>
        </ng-container>
      </div>
    </div>
    <div class="detail-actions-footer__toggle" *ngIf="!isVente()">
      <label class="toggle-switch-small toggle-switch-small--footer" [class.toggle-vert]="get('attente_reponse').value" [class.toggle-rouge]="!get('attente_reponse').value">
        <input
          type="checkbox"
          [formControl]="get('attente_reponse')"
          (change)="onAttenteReponseChange()"
          class="toggle-input">
        <span class="toggle-slider"></span>
        <span class="toggle-label-small">{{ get('attente_reponse').value ? 'Rien √† faire' : 'Client attend' }}</span>
      </label>
    </div>
  </footer>

  <div class="loading-area" *ngIf="isLoading()">
    <p>Chargement de la commande...</p>
  </div>
</div>

<!-- Popup de confirmation de suppression -->
<div class="delete-confirm-overlay" *ngIf="showDeleteConfirm()" (click)="closeDeleteConfirm()">
  <div class="delete-confirm-popup" (click)="$event.stopPropagation()">
    <div class="delete-confirm-header">
      <h3>Confirmer la suppression</h3>
    </div>
    <div class="delete-confirm-body">
      <p>√ätes-vous s√ªr de vouloir supprimer cette commande ?</p>
      <p class="delete-warning">Cette action est irr√©versible et supprimera d√©finitivement la commande de la base de donn√©es.</p>
    </div>
    <div class="delete-confirm-actions">
      <button type="button" class="btn-cancel-delete" (click)="closeDeleteConfirm()">Annuler</button>
      <button type="button" class="btn-confirm-delete" (click)="confirmDelete()">Supprimer</button>
    </div>
  </div>
</div>

<!-- Popup de confirmation duplication -->
<div class="delete-confirm-overlay duplicate-confirm" *ngIf="showDuplicateConfirm()" (click)="closeDuplicateConfirm()">
  <div class="delete-confirm-popup" (click)="$event.stopPropagation()">
    <div class="delete-confirm-header">
      <h3>Confirmer la duplication</h3>
    </div>
    <div class="delete-confirm-body">
      <p>√ätes-vous s√ªr de vouloir dupliquer cette {{ isVente() ? 'vente' : 'commande' }} ?</p>
      <p class="delete-warning">
        {{ isVente() ? 'Une nouvelle vente sera cr√©√©e en termin√©e.' : 'Une nouvelle commande sera cr√©√©e en ‚ÄúEn attente‚Äù.' }}
      </p>
    </div>
    <div class="delete-confirm-actions">
      <button type="button" class="btn-cancel-delete" (click)="closeDuplicateConfirm()">Non</button>
      <button type="button" class="btn-confirm-delete" (click)="confirmDuplicate()">Oui</button>
    </div>
  </div>
</div>

<!-- Popup duplication r√©ussie -->
<div class="delete-confirm-overlay duplicate-confirm" *ngIf="showDuplicateSuccess()" (click)="closeDuplicateSuccess()">
  <div class="delete-confirm-popup" (click)="$event.stopPropagation()">
    <div class="delete-confirm-header">
      <h3>{{ isVente() ? 'Vente' : 'Commande' }} bien dupliqu√©e</h3>
    </div>
    <div class="delete-confirm-body">
      <p>La {{ isVente() ? 'vente' : 'commande' }} a √©t√© dupliqu√©e avec succ√®s.</p>
    </div>
    <div class="delete-confirm-actions">
      <button type="button" class="btn-cancel-delete" (click)="closeDuplicateSuccess()">Rester sur la {{ isVente() ? 'vente' : 'commande' }}</button>
      <button type="button" class="btn-confirm-delete" (click)="viewDuplicatedCommande()">Voir la {{ isVente() ? 'vente' : 'commande' }} dupliqu√©e</button>
    </div>
  </div>
</div>
