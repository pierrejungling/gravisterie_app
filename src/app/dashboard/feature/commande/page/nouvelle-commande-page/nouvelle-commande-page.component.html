<app-header></app-header>

<div class="nouvelle-commande-wrapper">
  <div class="nouvelle-commande-container">
    <h1 class="page-title">Nouvelle Commande</h1>
    
    <!-- Popup de succ√®s am√©lior√© -->
    <div class="popup-overlay" *ngIf="showSuccessPopup()" (click)="showSuccessPopup.set(false)">
      <div class="popup-content" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h2 class="popup-title">Commande bien enregistr√©e</h2>
        </div>
        <div class="popup-body">
          <p class="popup-message">Votre commande a √©t√© cr√©√©e avec succ√®s !</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="btn-popup-secondary" (click)="onCreateNewCommande()">
            Cr√©er une nouvelle commande
          </button>
          <button type="button" class="btn-popup-primary" (click)="onViewCommandes()">
            Voir la commande
          </button>
        </div>
      </div>
    </div>
    
    <div class="error-area" *ngIf="errors().length > 0">
      <p *ngFor="let error of errors()">{{error.control}}: {{error.error}}</p>
    </div>

    <form [formGroup]="formGroup" (ngSubmit)="onSubmit()">
      
      <!-- Informations de la commande -->
      <section class="form-section">
        <h2 class="section-title">Informations de la commande</h2>
        
        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Nom / Intitul√© de la commande'"
            [control]="get('nom_commande')"
            [formGroup]="formGroup">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Deadline'"
            [control]="get('deadline')"
            [formGroup]="formGroup"
            type="date">
          </app-floating-label-input>
        </div>
      </section>

      <!-- Coordonn√©es de contact -->
      <section class="form-section">
        <h2 class="section-title">Coordonn√©es de contact</h2>
        
        <div class="form-row">
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Nom'"
              [control]="getCoordonneeControl('nom')"
              [formGroup]="coordonneesContact">
            </app-floating-label-input>
          </div>
          
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Pr√©nom'"
              [control]="getCoordonneeControl('prenom')"
              [formGroup]="coordonneesContact">
            </app-floating-label-input>
          </div>
        </div>

        <div class="form-row">
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'T√©l√©phone'"
              [control]="getCoordonneeControl('telephone')"
              [formGroup]="coordonneesContact"
              type="tel">
            </app-floating-label-input>
          </div>
          
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Email'"
              [control]="getCoordonneeControl('mail')"
              [formGroup]="coordonneesContact"
              type="email">
            </app-floating-label-input>
          </div>
        </div>

        <!-- Adresse d√©compos√©e -->
        <div class="address-section">
          <label class="section-subtitle">Adresse</label>
          
          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Rue et num√©ro'"
              [control]="getCoordonneeControl('rue')"
              [formGroup]="coordonneesContact">
            </app-floating-label-input>
          </div>

          <div class="form-row">
            <div class="input-wrapper">
              <app-floating-label-input
                [label]="'Code postal'"
                [control]="getCoordonneeControl('code_postal')"
                [formGroup]="coordonneesContact">
              </app-floating-label-input>
            </div>
            
            <div class="input-wrapper">
              <app-floating-label-input
                [label]="'Ville'"
                [control]="getCoordonneeControl('ville')"
                [formGroup]="coordonneesContact">
              </app-floating-label-input>
            </div>
          </div>

          <div class="input-wrapper">
            <app-floating-label-input
              [label]="'Pays'"
              [control]="getCoordonneeControl('pays')"
              [formGroup]="coordonneesContact">
            </app-floating-label-input>
          </div>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'TVA'"
            [control]="getCoordonneeControl('tva')"
            [formGroup]="coordonneesContact">
          </app-floating-label-input>
        </div>
      </section>

      <!-- Description du projet -->
      <section class="form-section">
        <h2 class="section-title">Description du projet</h2>
        
        <div class="input-wrapper">
          <textarea
            class="textarea-input"
            formControlName="description_projet"
            placeholder="D√©crivez votre projet..."
            rows="5">
          </textarea>
        </div>
      </section>

      <!-- Dimensions et support -->
      <section class="form-section">
        <h2 class="section-title">Dimensions et support</h2>
        
        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Dimensions souhait√©es'"
            [control]="get('dimensions_souhaitees')"
            [formGroup]="formGroup">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Quantit√©'"
            [control]="get('quantit√©')"
            [formGroup]="formGroup"
            type="number">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <div class="paye-status-block" [class.paye-oui]="formGroup.get('pay√©')?.value" [class.paye-non]="!formGroup.get('pay√©')?.value">
            <label class="checkbox-label-paye">
              <input
                type="checkbox"
                formControlName="pay√©">
              <span class="paye-label-text">{{ formGroup.get('pay√©')?.value ? 'Pay√©' : 'Non pay√©' }}</span>
            </label>
            <div class="paye-commentaire-wrapper">
              <textarea
                class="paye-commentaire-input"
                formControlName="commentaire_paye"
                placeholder="Commentaire..."
                rows="3">
              </textarea>
            </div>
          </div>
        </div>

        <div class="input-wrapper">
          <div class="support-input-wrapper">
            <input
              class="support-input"
              type="text"
              [formControl]="get('support')"
              [placeholder]="getSupportPlaceholder()"
              (focus)="onSupportFocus($event)"
              (blur)="onSupportBlur()">
            <label 
              class="support-label"
              [class.fixed-label]="get('support').value && get('support').value.length > 0">
              Support
            </label>
          </div>
          <p class="input-hint" *ngIf="!get('support').value || get('support').value.length === 0">
            Par d√©faut: {{ supportParDefaut }}
          </p>
        </div>
      </section>

      <!-- Personnalisation -->
      <section class="form-section">
        <h2 class="section-title">Personnalisation</h2>
        
        <div class="input-wrapper">
          <label class="label">Couleur (s√©lection multiple)</label>
          <div class="couleur-checkboxes">
            <label *ngFor="let couleur of couleursDisponibles" class="checkbox-label">
              <input
                type="checkbox"
                [checked]="isCouleurSelected(couleur)"
                (change)="toggleCouleur(couleur)">
              <span>{{couleur}}</span>
            </label>
          </div>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Police d\'√©criture'"
            [control]="get('police_ecriture')"
            [formGroup]="formGroup">
          </app-floating-label-input>
        </div>

        <div class="input-wrapper">
          <app-floating-label-input
            [label]="'Texte de la personnalisation'"
            [control]="get('texte_personnalisation')"
            [formGroup]="formGroup">
          </app-floating-label-input>
        </div>
      </section>

      <!-- Statut initial -->
      <section class="form-section">
        <h2 class="section-title">Statut initial (optionnel)</h2>
        <p class="section-hint">Si aucun statut n'est s√©lectionn√©, la commande sera cr√©√©e avec le statut "En Attente de + d'infos" par d√©faut. Les statuts pr√©c√©dents seront automatiquement valid√©s.</p>
        
        <div class="statuts-radio-group">
          <label *ngFor="let statut of statuts" class="statut-radio-label">
            <input
              type="radio"
              name="statut_initial"
              [value]="statut"
              [checked]="isStatutSelected(statut)"
              (change)="onStatutChange(statut)">
            <span>{{ statutLabels[statut] }}</span>
          </label>
        </div>
      </section>

      <!-- Fichiers joints -->
      <section class="form-section">
        <h2 class="section-title">Fichiers joints</h2>
        
        <div 
          class="file-upload-area"
          [class.drag-over]="isDragOver"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          <input
            type="file"
            id="file-input"
            multiple
            accept="image/*,.pdf,.doc,.docx"
            (change)="onFileSelected($event)"
            style="display: none;">
          <label for="file-input" class="file-upload-label">
            <span>üìé Cliquez ou glissez-d√©posez des fichiers ici</span>
            <small>Formats accept√©s: Images, PDF, DOC, DOCX</small>
          </label>
        </div>

        <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
          <div *ngFor="let file of uploadedFiles; let i = index" class="file-item">
            <span>{{file.name}}</span>
            <button type="button" class="remove-file-btn" (click)="removeFile(i)">‚úï</button>
          </div>
        </div>
      </section>

      <!-- Boutons d'action -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="onCancel()">Annuler</button>
        <button type="submit" class="btn-primary" [disabled]="!isFormValid()">
          Cr√©er la commande
        </button>
      </div>
    </form>
  </div>
</div>
